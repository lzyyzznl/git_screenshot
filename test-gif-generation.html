<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>GIFç”Ÿæˆæµ‹è¯•</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			.container {
				text-align: center;
			}
			button {
				background: #007cba;
				color: white;
				border: none;
				padding: 10px 20px;
				margin: 10px;
				border-radius: 5px;
				cursor: pointer;
				font-size: 16px;
			}
			button:hover {
				background: #005a87;
			}
			button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}
			.log {
				text-align: left;
				background: #f5f5f5;
				padding: 10px;
				margin: 20px 0;
				border-radius: 5px;
				max-height: 300px;
				overflow-y: auto;
			}
			.progress {
				width: 100%;
				height: 20px;
				background: #f0f0f0;
				border-radius: 10px;
				margin: 20px 0;
			}
			.progress-bar {
				height: 100%;
				background: #007cba;
				border-radius: 10px;
				width: 0%;
				transition: width 0.3s ease;
			}
			.preview {
				margin: 20px 0;
				border: 2px dashed #ccc;
				padding: 20px;
				border-radius: 10px;
			}
			.canvas-container {
				margin: 20px 0;
			}
			canvas {
				border: 1px solid #ccc;
				margin: 10px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ğŸ¨ GIFç”ŸæˆåŠŸèƒ½æµ‹è¯•</h1>
			<p>è¿™ä¸ªæµ‹è¯•é¡µé¢å°†åˆ›å»ºä¸€ä¸ªçœŸå®çš„GIFåŠ¨ç”»æ–‡ä»¶</p>

			<div class="canvas-container">
				<h3>é¢„è§ˆç”»å¸ƒ:</h3>
				<canvas id="previewCanvas" width="200" height="200"></canvas>
			</div>

			<button id="generateBtn" onclick="generateTestGif()">
				ğŸ¬ ç”Ÿæˆæµ‹è¯•GIF
			</button>
			<button id="clearBtn" onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>

			<div class="progress">
				<div class="progress-bar" id="progressBar"></div>
			</div>
			<div id="progressText">å‡†å¤‡å¼€å§‹...</div>

			<div class="log" id="logContainer"></div>

			<div class="preview" id="previewContainer">
				<p>ç”Ÿæˆçš„GIFå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
			</div>
		</div>

		<!-- å¼•å…¥gif.jsåº“ -->
		<script src="node_modules/gif.js/dist/gif.js"></script>

		<script>
			let currentGif = null;

			function log(message) {
				const logContainer = document.getElementById("logContainer");
				const time = new Date().toLocaleTimeString();
				logContainer.innerHTML += `<div>[${time}] ${message}</div>`;
				logContainer.scrollTop = logContainer.scrollHeight;
				console.log(message);
			}

			function clearLog() {
				document.getElementById("logContainer").innerHTML = "";
				document.getElementById("progressText").textContent = "å‡†å¤‡å¼€å§‹...";
				updateProgress(0);
			}

			function updateProgress(percentage) {
				const progressBar = document.getElementById("progressBar");
				const progressText = document.getElementById("progressText");
				progressBar.style.width = percentage + "%";
				progressText.textContent = `è¿›åº¦: ${Math.round(percentage)}%`;
			}

			function setButtonState(enabled) {
				document.getElementById("generateBtn").disabled = !enabled;
			}

			async function generateTestGif() {
				try {
					setButtonState(false);
					clearLog();
					log("ğŸ¬ å¼€å§‹ç”ŸæˆGIFæµ‹è¯•...");

					// æ£€æŸ¥gif.jsæ˜¯å¦å¯ç”¨
					if (typeof GIF === "undefined") {
						throw new Error("GIF.jsåº“æœªåŠ è½½");
					}
					log("âœ… GIF.jsåº“å·²åŠ è½½");

					// åˆ›å»ºGIFå®ä¾‹ï¼ˆä½¿ç”¨ä¸»çº¿ç¨‹æ¨¡å¼ï¼‰
					const gif = new GIF({
						workers: 0, // ä¸»çº¿ç¨‹æ¨¡å¼ï¼Œé¿å…workeré—®é¢˜
						quality: 10,
						width: 200,
						height: 200,
						debug: false,
						dither: false,
						background: "#ffffff",
					});
					log("âœ… GIFå®ä¾‹åˆ›å»ºæˆåŠŸ");

					// è·å–é¢„è§ˆç”»å¸ƒ
					const canvas = document.getElementById("previewCanvas");
					const ctx = canvas.getContext("2d");

					// ç”ŸæˆåŠ¨ç”»å¸§
					const frameCount = 12;
					const colors = [
						"#ff0000",
						"#ff8800",
						"#ffff00",
						"#88ff00",
						"#00ff00",
						"#00ff88",
						"#00ffff",
						"#0088ff",
						"#0000ff",
						"#8800ff",
						"#ff00ff",
						"#ff0088",
					];

					for (let i = 0; i < frameCount; i++) {
						// æ¸…é™¤ç”»å¸ƒ
						ctx.clearRect(0, 0, 200, 200);

						// ç»˜åˆ¶èƒŒæ™¯æ¸å˜
						const gradient = ctx.createRadialGradient(
							100,
							100,
							0,
							100,
							100,
							100
						);
						gradient.addColorStop(0, colors[i]);
						gradient.addColorStop(1, "#ffffff");
						ctx.fillStyle = gradient;
						ctx.fillRect(0, 0, 200, 200);

						// ç»˜åˆ¶æ—‹è½¬çš„å½¢çŠ¶
						ctx.save();
						ctx.translate(100, 100);
						ctx.rotate((i / frameCount) * Math.PI * 2);

						// ç»˜åˆ¶æ˜Ÿå½¢
						ctx.fillStyle = "#000000";
						ctx.beginPath();
						for (let j = 0; j < 5; j++) {
							const angle = (j / 5) * Math.PI * 2;
							const x = Math.cos(angle) * 30;
							const y = Math.sin(angle) * 30;
							if (j === 0) ctx.moveTo(x, y);
							else ctx.lineTo(x, y);

							const innerAngle = ((j + 0.5) / 5) * Math.PI * 2;
							const innerX = Math.cos(innerAngle) * 15;
							const innerY = Math.sin(innerAngle) * 15;
							ctx.lineTo(innerX, innerY);
						}
						ctx.closePath();
						ctx.fill();
						ctx.restore();

						// æ·»åŠ æ–‡å­—
						ctx.fillStyle = "#000000";
						ctx.font = "bold 16px Arial";
						ctx.textAlign = "center";
						ctx.fillText(`å¸§ ${i + 1}/${frameCount}`, 100, 30);

						// æ·»åŠ æ—¶é—´æˆ³
						ctx.font = "12px Arial";
						ctx.fillText(new Date().toLocaleTimeString(), 100, 185);

						// æ·»åŠ å¸§åˆ°GIF
						gif.addFrame(canvas, { delay: 250 }); // 250msæ¯å¸§
						log(`âœ… æ·»åŠ ç¬¬ ${i + 1} å¸§`);

						// æ›´æ–°è¿›åº¦
						updateProgress(((i + 1) / frameCount) * 50); // å‰50%æ˜¯å¸§åˆ›å»º

						// è®©UIæ›´æ–°
						await new Promise((resolve) => setTimeout(resolve, 50));
					}

					log("ğŸ¬ å¼€å§‹æ¸²æŸ“GIFæ–‡ä»¶...");

					// æ¸²æŸ“GIF
					const gifBlob = await new Promise((resolve, reject) => {
						const timeout = setTimeout(() => {
							reject(new Error("GIFæ¸²æŸ“è¶…æ—¶ï¼ˆ30ç§’ï¼‰"));
						}, 30000);

						gif.on("finished", (blob) => {
							clearTimeout(timeout);
							log("âœ… GIFæ¸²æŸ“å®Œæˆï¼");
							resolve(blob);
						});

						gif.on("error", (err) => {
							clearTimeout(timeout);
							log(`âŒ GIFæ¸²æŸ“é”™è¯¯: ${err}`);
							reject(err);
						});

						gif.on("progress", (progress) => {
							const percentage = 50 + progress * 50; // å50%æ˜¯æ¸²æŸ“
							updateProgress(percentage);
							log(`ğŸ”„ æ¸²æŸ“è¿›åº¦: ${Math.round(progress * 100)}%`);
						});

						gif.render();
					});

					// éªŒè¯ç”Ÿæˆçš„GIF
					if (!gifBlob || gifBlob.size === 0) {
						throw new Error("ç”Ÿæˆçš„GIFæ–‡ä»¶ä¸ºç©º");
					}

					log(`ğŸ‰ GIFç”ŸæˆæˆåŠŸï¼`);
					log(
						`ğŸ“Š æ–‡ä»¶å¤§å°: ${gifBlob.size} å­—èŠ‚ (${(gifBlob.size / 1024).toFixed(2)} KB)`
					);
					log(`ğŸ“ æ–‡ä»¶ç±»å‹: ${gifBlob.type}`);

					// éªŒè¯GIFæ–‡ä»¶å¤´
					const reader = new FileReader();
					reader.onload = (e) => {
						const arrayBuffer = e.target.result;
						const uint8Array = new Uint8Array(arrayBuffer);
						const header = Array.from(uint8Array.slice(0, 6))
							.map((b) => String.fromCharCode(b))
							.join("");

						if (header === "GIF89a" || header === "GIF87a") {
							log(`âœ… æœ‰æ•ˆçš„GIFæ–‡ä»¶å¤´: ${header}`);
						} else {
							log(`âš ï¸ æ— æ•ˆçš„GIFæ–‡ä»¶å¤´: ${header}`);
						}
					};
					reader.readAsArrayBuffer(gifBlob);

					// æ˜¾ç¤ºé¢„è§ˆ
					const previewContainer = document.getElementById("previewContainer");
					const url = URL.createObjectURL(gifBlob);
					previewContainer.innerHTML = `
                    <h3>ğŸ–¼ï¸ ç”Ÿæˆçš„GIFé¢„è§ˆ:</h3>
                    <img src="${url}" alt="ç”Ÿæˆçš„GIF" style="max-width: 100%; border: 1px solid #ccc; border-radius: 5px;">
                    <br><br>
                    <a href="${url}" download="test-animated-${Date.now()}.gif" style="display: inline-block; background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 10px;">
                        ğŸ’¾ ä¸‹è½½GIFæ–‡ä»¶
                    </a>
                    <button onclick="copyToClipboard('${url}')" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 10px; cursor: pointer;">
                        ğŸ“‹ å¤åˆ¶URL
                    </button>
                `;

					// ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›è°ƒè¯•
					window.generatedGif = {
						blob: gifBlob,
						url: url,
						size: gifBlob.size,
						type: gifBlob.type,
					};

					log("ğŸ“ GIFæ–‡ä»¶å·²å‡†å¤‡å¥½ä¸‹è½½ï¼");
					log("ğŸ” å¯é€šè¿‡ window.generatedGif åœ¨å¼€å‘è€…å·¥å…·ä¸­è®¿é—®");
					updateProgress(100);
				} catch (error) {
					log(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`);
					updateProgress(0);
				} finally {
					setButtonState(true);
				}
			}

			function copyToClipboard(text) {
				navigator.clipboard
					.writeText(text)
					.then(() => {
						log("ğŸ“‹ URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
					})
					.catch(() => {
						log("âŒ æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿");
					});
			}

			// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
			window.onload = function () {
				log("ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ");
				log("ğŸ”§ æ­£åœ¨æ£€æŸ¥ä¾èµ–...");

				if (typeof GIF !== "undefined") {
					log("âœ… GIF.jsåº“å·²å°±ç»ª");
				} else {
					log("âŒ GIF.jsåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ä¾èµ–");
				}

				log("ğŸš€ å‡†å¤‡ç”Ÿæˆæµ‹è¯•GIF");
			};
		</script>
	</body>
</html>
